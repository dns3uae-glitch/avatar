<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3D Crime Scene Updated</title>
<style>
body,html{margin:0;height:100%;background:#06060a;color:#fff;font-family:sans-serif}
header{height:60px;background:#0c0e12;display:flex;align-items:center;padding:0 16px;gap:8px}
button{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;background:#f59e0b;color:#000;font-weight:700}
#canvas-container{position:relative;width:100%;height:calc(100% - 60px)}
#three-canvas{width:100%;height:100%;display:block}
</style>
</head>
<body>
<header>
<button id="loadCrimeSceneBtn">تحميل مشهد الجريمة</button>
</header>
<div id="canvas-container">
<canvas id="three-canvas"></canvas>
</div>

<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
<script>
let scene, camera, renderer, controls;

function initThree() {
    const canvas = document.getElementById('three-canvas');
    renderer = new THREE.WebGLRenderer({canvas, antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.outputEncoding = THREE.sRGBEncoding;

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x040405);

    camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 2000);
    camera.position.set(0,4,8);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.target.set(0,1,0); controls.update();

    const floor = new THREE.Mesh(new THREE.PlaneGeometry(10,12), new THREE.MeshStandardMaterial({color:0x222222, roughness:0.9}));
    floor.rotation.x = -Math.PI/2; floor.receiveShadow=true; scene.add(floor);

    const ambient = new THREE.AmbientLight(0xffffff,0.12); scene.add(ambient);

    const mainSpot = new THREE.SpotLight(0xfff2d6,2.0,40,Math.PI/8,0.2,1);
    mainSpot.position.set(0.5,5,1); mainSpot.castShadow=true; scene.add(mainSpot);

    const grid = new THREE.GridHelper(20,40,0x333333,0x1a1a1a); grid.position.y=0.01; scene.add(grid);

    window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight-60);
    });
    renderer.setSize(window.innerWidth, window.innerHeight-60);
}

function animate() { requestAnimationFrame(animate); renderer.render(scene,camera); }
initThree();
animate();

document.getElementById("loadCrimeSceneBtn").addEventListener("click", async () => {
    try {
        const response = await fetch("./presets/crime_scene_bedroom.json");
        if (!response.ok) throw new Error("Failed to load scene preset");
        const data = await response.json();
        console.log("Loaded preset:", data);
        loadCrimeScene(data);
    } catch (err) {
        console.error("Error loading crime scene:", err);
        alert("حدث خطأ أثناء تحميل مشهد الجريمة");
    }
});

function loadCrimeScene(data) {
    scene.children.filter(o=>o.userData?.isDynamic).forEach(o=>scene.remove(o));

    data.objects.forEach(obj => {
        let mesh;
        switch(obj.type){
            case "Bed":
                mesh = new THREE.Mesh(new THREE.BoxGeometry(2,0.5,1.6), new THREE.MeshStandardMaterial({color:0x6b4b3b,roughness:0.7}));
                break;
            case "Nightstand":
                mesh = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.6,0.4), new THREE.MeshStandardMaterial({color:0x3f2b20,roughness:0.9}));
                break;
            case "Mannequin":
                mesh = new THREE.Mesh(new THREE.BoxGeometry(0.3,1,0.3), new THREE.MeshStandardMaterial({color:0x8b6b5a,roughness:0.8}));
                break;
            case "Gun":
                mesh = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.1,0.6), new THREE.MeshStandardMaterial({color:0x111316, metalness:0.9, roughness:0.25}));
                break;
            case "BloodPatch":
                mesh = new THREE.Mesh(new THREE.CircleGeometry(obj.radius || 0.2,32), new THREE.MeshStandardMaterial({color:0x6b0000,transparent:true,opacity:0.85}));
                mesh.rotation.x = -Math.PI/2;
                break;
            case "Marker":
                const canvas = document.createElement('canvas'); canvas.width=128; canvas.height=64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle="#ffe066"; ctx.fillRect(0,0,128,64);
                ctx.fillStyle="#000"; ctx.font="bold 48px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
                ctx.fillText(obj.num,64,32);
                const tex = new THREE.CanvasTexture(canvas);
                mesh = new THREE.Mesh(new THREE.PlaneGeometry(0.25,0.15), new THREE.MeshStandardMaterial({map:tex, side:THREE.DoubleSide}));
                mesh.rotation.y = Math.PI/4;
                break;
        }
        if(mesh){
            mesh.position.set(...(obj.position||[0,0,0]));
            if(obj.rotation) mesh.rotation.set(...obj.rotation);
            if(obj.scale) mesh.scale.set(...obj.scale);
            mesh.userData.isDynamic=true;
            scene.add(mesh);
        }
    });
    alert("تم تحميل مشهد الجريمة بنجاح ("+data.objects.length+" عناصر)");
}
</script>
</body>
</html>
