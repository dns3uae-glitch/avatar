<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>مسرح الجريمة 3D تفاعلي</title>
<style>
  body { margin:0; overflow:hidden; background:#111; }
  canvas { display:block; }
  .controls {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    display: grid; grid-template-areas: ". up ." "left . right" ". down ."; gap: 10px;
  }
  button {
    width: 50px; height: 50px; font-size: 18px; border:none;
    border-radius: 5px; background:#444; color:#fff; cursor:pointer;
  }
</style>
</head>
<body>

<div class="controls">
  <button id="up" style="grid-area: up;">↑</button>
  <button id="down" style="grid-area: down;">↓</button>
  <button id="left" style="grid-area: left;">←</button>
  <button id="right" style="grid-area: right;">→</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>
<script>
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x202020);

  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 50);
  camera.position.set(0,1.5,5);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  document.body.appendChild(renderer.domElement);

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // إضاءة
  const ambientLight = new THREE.AmbientLight(0xffffff,0.5);
  scene.add(ambientLight);

  const spotLight = new THREE.SpotLight(0xffffff,1);
  spotLight.position.set(3,5,3);
  spotLight.castShadow = true;
  scene.add(spotLight);

  // الغرفة
  const floorMaterial = new THREE.MeshStandardMaterial({color:0x654321});
  const wallMaterial = new THREE.MeshStandardMaterial({color:0x888888});
  const ceilingMaterial = new THREE.MeshStandardMaterial({color:0xffffff});

  const floor = new THREE.Mesh(new THREE.PlaneGeometry(10,10), floorMaterial);
  floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

  const backWall = new THREE.Mesh(new THREE.PlaneGeometry(10,5), wallMaterial);
  backWall.position.set(0,2.5,-5); scene.add(backWall);

  const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(10,5), wallMaterial);
  leftWall.rotation.y = Math.PI/2; leftWall.position.set(-5,2.5,0); scene.add(leftWall);

  const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(10,5), wallMaterial);
  rightWall.rotation.y = -Math.PI/2; rightWall.position.set(5,2.5,0); scene.add(rightWall);

  const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(10,10), ceilingMaterial);
  ceiling.rotation.x = Math.PI/2; ceiling.position.y = 5; scene.add(ceiling);

  // أدوات شبه واقعية
  const knife = new THREE.Mesh(
    new THREE.BoxGeometry(0.15,0.02,0.6),
    new THREE.MeshStandardMaterial({color:0xc0c0c0, metalness:0.8, roughness:0.2})
  );
  knife.position.set(-1,0.05,1); knife.castShadow = true; scene.add(knife);

  const gun = new THREE.Mesh(
    new THREE.BoxGeometry(0.35,0.15,0.6),
    new THREE.MeshStandardMaterial({color:0x111111, metalness:0.7, roughness:0.3})
  );
  gun.position.set(1,0.05,-1); gun.castShadow = true; scene.add(gun);

  const glove = new THREE.Mesh(
    new THREE.SphereGeometry(0.2,16,16),
    new THREE.MeshStandardMaterial({color:0xffffff, metalness:0, roughness:0.5})
  );
  glove.position.set(0,0.2,0); glove.castShadow = true; scene.add(glove);

  const cup = new THREE.Mesh(
    new THREE.CylinderGeometry(0.2,0.2,0.3,16),
    new THREE.MeshStandardMaterial({color:0xffffff, metalness:0, roughness:0.1})
  );
  cup.position.set(0.5,0.15,0.5); cup.castShadow = true; scene.add(cup);

  const table = new THREE.Mesh(
    new THREE.BoxGeometry(2,0.1,1),
    new THREE.MeshStandardMaterial({color:0x222222, metalness:0.1, roughness:0.6})
  );
  table.position.set(0,0.5,0); table.castShadow = true; scene.add(table);

  // تحكم بالكاميرا
  const moveSpeed = 0.1;
  const rotateSpeed = 0.03;
  const keys = {up:false, down:false, left:false, right:false};
  let cameraRotationY = 0;

  document.getElementById('up').addEventListener('mousedown', ()=> keys.up=true);
  document.getElementById('up').addEventListener('mouseup', ()=> keys.up=false);
  document.getElementById('down').addEventListener('mousedown', ()=> keys.down=true);
  document.getElementById('down').addEventListener('mouseup', ()=> keys.down=false);
  document.getElementById('left').addEventListener('mousedown', ()=> keys.left=true);
  document.getElementById('left').addEventListener('mouseup', ()=> keys.left=false);
  document.getElementById('right').addEventListener('mousedown', ()=> keys.right=true);
  document.getElementById('right').addEventListener('mouseup', ()=> keys.right=false);

  window.addEventListener('keydown', e=>{
    if(e.key==='ArrowUp') keys.up=true;
    if(e.key==='ArrowDown') keys.down=true;
    if(e.key==='ArrowLeft') keys.left=true;
    if(e.key==='ArrowRight') keys.right=true;
  });
  window.addEventListener('keyup', e=>{
    if(e.key==='ArrowUp') keys.up=false;
    if(e.key==='ArrowDown') keys.down=false;
    if(e.key==='ArrowLeft') keys.left=false;
    if(e.key==='ArrowRight') keys.right=false;
  });

  // التفاعل مع الأدوات
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  let selectedObject = null;

  function onPointerMove(event){
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  }
  window.addEventListener('mousemove', onPointerMove);
  window.addEventListener('touchmove', e=>{
    mouse.x = (e.touches[0].clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.touches[0].clientY / window.innerHeight) * 2 + 1;
  });

  window.addEventListener('mousedown', ()=>{
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects([knife, gun, glove, cup]);
    if(intersects.length>0){
      selectedObject = intersects[0].object;
    }
  });
  window.addEventListener('mouseup', ()=>{selectedObject=null;});
  window.addEventListener('touchstart', ()=>{
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects([knife, gun, glove, cup]);
    if(intersects.length>0) selectedObject = intersects[0].object;
  });
  window.addEventListener('touchend', ()=>{selectedObject=null;});

  function animate(){
    requestAnimationFrame(animate);

    if(keys.left) cameraRotationY += rotateSpeed;
    if(keys.right) cameraRotationY -= rotateSpeed;

    const dirX = Math.sin(cameraRotationY);
    const dirZ = Math.cos(cameraRotationY);

    if(keys.up){
      camera.position.x += dirX*moveSpeed;
      camera.position.z += dirZ*moveSpeed;
    }
    if(keys.down){
      camera.position.x -= dirX*moveSpeed;
      camera.position.z -= dirZ*moveSpeed;
    }

    camera.lookAt(camera.position.x+dirX, camera.position.y, camera.position.z+dirZ);

    // تحريك الأداة المحددة حسب الماوس
    if(selectedObject){
      raycaster.setFromCamera(mouse, camera);
      const planeZ = new THREE.Plane(new THREE.Vector3(0,1,0), -selectedObject.position.y);
      const intersect = new THREE.Vector3();
      raycaster.ray.intersectPlane(planeZ, intersect);
      if(intersect) selectedObject.position.x = intersect.x, selectedObject.position.z = intersect.z;
    }

    // توهج الأدوات عند المرور عليها
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects([knife, gun, glove, cup]);
    [knife, gun, glove, cup].forEach(obj => obj.material.emissive.setHex(0x000000));
    if(intersects.length>0) intersects[0].object.material.emissive.setHex(0x333333);

    renderer.render(scene,camera);
  }
  animate();
</script>
</body>
</html>
